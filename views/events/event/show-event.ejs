<% layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/css/global.css">
<link rel="stylesheet" href="/css/nav.css">
<link rel="stylesheet" href="/css/styles.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<body class="d-flex flex-column vh-100">
    <div class="detail-container">
        <!-- Seats Section -->
        <div class="seats">
            <div class="seats-layout">
                <% seats.forEach(seat => { %>
                    <% 
                        const ticket = seatsWithTickets[seat.seatNumber]; 
                        const isReservedByCurrentUser = seat.reservedBy && seat.reservedBy.equals(currentUser);
                        let seatClass = '';
                        let seatStatus = '';
                        const isCancelled = ticket && ticket.status === 'cancelled';

                        // Determine if the user can unreserve the seat
                        const canUnreserve = seat.isReserved && isReservedByCurrentUser;
                    
                        // Determine seat class based on ticket type
                        if (ticket && !isCancelled) {
                            switch(ticket.type) {
                                case 'تذكرة كاملة':
                                    seatClass = 'seat-full';
                                    break;
                                case 'نصف تذكرة':
                                    seatClass = 'seat-half';
                                    break;
                                case 'حجز مالك':
                                    seatClass = 'seat-owner';
                                    break;
                                default:
                                    seatClass = '';
                                    break;
                            }
                        }

                        if (!ticket && seat.isReserved) {
                            seatClass = 'seat-temporary'
                        }

                        // Determine seat status based on reservation
                        seatStatus = seat.isReserved ? 'الغاء الحجز المؤقت' : 'حجز مؤقت';

                        const isDisabled = ticket && !isCancelled ? 'disabled' : '';
                    %>

                    <!-- Seat Dropdown -->
                    <div class="dropdown">
                        <button id="seat" class="btn btn-default dropdown-toggle <%= seatClass %>" type="button" data-toggle="dropdown">
                            <%= seat.seatNumber %>
                        </button>

                        <ul class="dropdown-menu">
                            <% if (!ticket && !seat.isReserved) { %>
                                <!-- Empty or cancelled seat options -->
                                <li>
                                    <a href="#" class="toggle-reservation" data-seat-id="<%= seat._id %>"><%= seat.isReserved ? 'الغاء الحجز المؤقت' : 'حجز مؤقت' %></a>
                                </li>

                                <!-- Full and Half Ticket options -->
                                <li class="dropdown-submenu">
                                    <a tabindex="-1" class="test" href="#">حجز كامل <i class="fa-solid fa-caret-down"></i></a>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a tabindex="-1" href="/tickets/add-full-ticket/<%= event._id %>?seatNumber=<%= seat.seatNumber %>">تذكرة كاملة</a>
                                        </li>
                                        <li>
                                            <a tabindex="-1" href="/tickets/add-half-ticket/<%= event._id %>?seatNumber=<%= seat.seatNumber %>">نصف تذكرة</a>
                                        </li>
                                    </ul>
                                </li>

                                <!-- Owner Ticket option -->
                                <li>
                                    <a href="/tickets/add-owner-ticket/<%= event._id %>?seatNumber=<%= seat.seatNumber %>">حجز مالك</a>
                                </li>

                                <!-- Cancel Ticket option -->
                                <li class="dropdown-submenu">
                                    <a style="color: gray !important; cursor: not-allowed;" tabindex="-1" href="#">الغاء تذكرة</a>
                                    <ul class="dropdown-menu" style="text-align: center;">
                                        <p>هل انت متأكد من الغاء التذكرة</p>
                                        <li>
                                            <% if (ticket) { %>
                                                <a style="background-color: green; color: white !important; width: 50%; border-radius: 5px; padding: 10px 0;" href="/tickets/cancel/<%= ticket._id %>">نعم</a>
                                            <% } else { %>
                                                <a style="background-color: grey; color: white !important; width: 50%; border-radius: 5px; padding: 10px 0;">No ticket to cancel</a>
                                            <% } %>
                                        </li>
                                        <li>
                                            <a style="background-color: red; color: white !important; width: 50%; border-radius: 5px; padding: 10px 0;" href="#">لا</a>
                                        </li>
                                    </ul>
                                </li>
                            <% } else if(ticket) { %>
                                <!-- Existing ticket options -->
                                <li>
                                    <a href="#" style="color: gray !important; cursor: not-allowed;">حجز مؤقت</a>
                                </li>
                                <li>
                                    <a style="color: gray !important; cursor: not-allowed;" href="#">حجز كامل</a>
                                </li>
                                <li>
                                    <a style="color: gray !important; cursor: not-allowed;" href="#">حجز مالك</a>
                                </li>
                                <li class="dropdown-submenu">
                                    <a class="test" tabindex="-1" href="#">الغاء التذكرة</a>
                                    <ul class="dropdown-menu" style="text-align: center;">
                                        <p>هل انت متأكد من الغاء التذكرة</p>
                                        <li>
                                            <% if (ticket) { %>
                                                <a style="background-color: green; color: white !important; width: 50%; border-radius: 5px; padding: 10px 0;" href="/tickets/cancel/<%= ticket._id %>">نعم</a>
                                            <% } else { %>
                                                <a style="background-color: grey; color: white !important; width: 50%; border-radius: 5px; padding: 10px 0;">No ticket to cancel</a>
                                            <% } %>                                        
                                        </li>
                                        <li>
                                            <a style="background-color: red; color: white !important; width: 50%; border-radius: 5px; padding: 10px 0;" href="#">لا</a>
                                        </li>
                                    </ul>
                                </li>
                            <% }else if(!ticket && seat.isReserved && canUnreserve) { %>

                                <li>
                                    <a href="#" class="toggle-reservation" data-seat-id="<%= seat._id %>"><%= seat.isReserved ? 'الغاء الحجز المؤقت' : 'حجز مؤقت' %></a>
                                </li>

                                <!-- Full and Half Ticket options -->
                                <li class="dropdown-submenu">
                                    <a style="color: gray !important; cursor: not-allowed;" tabindex="-1" href="#">حجز كامل <i class="fa-solid fa-caret-down"></i></a>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a tabindex="-1" href="/tickets/add-full-ticket/<%= event._id %>?seatNumber=<%= seat.seatNumber %>">تذكرة كاملة</a>
                                        </li>
                                        <li>
                                            <a tabindex="-1" href="/tickets/add-half-ticket/<%= event._id %>?seatNumber=<%= seat.seatNumber %>">نصف تذكرة</a>
                                        </li>
                                    </ul>
                                </li>

                                <!-- Owner Ticket option -->
                                <li>
                                    <a style="color: gray !important; cursor: not-allowed;" href="">حجز مالك</a>
                                </li>

                                <!-- Cancel Ticket option -->
                                <li class="dropdown-submenu">
                                    <a style="color: gray !important; cursor: not-allowed;" tabindex="-1" href="#">الغاء تذكرة</a>
                                    <ul class="dropdown-menu" style="text-align: center;">
                                        <p>هل انت متأكد من الغاء التذكرة</p>
                                        <li>
                                            <% if (ticket) { %>
                                                <a style="background-color: green; color: white !important; width: 50%; border-radius: 5px; padding: 10px 0;" href="/tickets/cancel/<%= ticket._id %>">نعم</a>
                                            <% } else { %>
                                                <a style="background-color: grey; color: white !important; width: 50%; border-radius: 5px; padding: 10px 0;">No ticket to cancel</a>
                                            <% } %>
                                        </li>
                                        <li>
                                            <a style="background-color: red; color: white !important; width: 50%; border-radius: 5px; padding: 10px 0;" href="#">لا</a>
                                        </li>
                                    </ul>
                                </li>

                                <% } else if(!ticket && seat.isReserved && !canUnreserve) { %>

                                <li>
                                    <a href="#" style="color: gray !important; cursor: not-allowed;" data-seat-id="<%= seat._id %>"><%= seat.isReserved ? 'الغاء الحجز المؤقت' : 'حجز مؤقت' %></a>
                                </li>

                                <!-- Full and Half Ticket options -->
                                <li class="dropdown-submenu">
                                    <a tabindex="-1" style="color: gray !important; cursor: not-allowed;" href="#">حجز كامل <i class="fa-solid fa-caret-down"></i></a>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a tabindex="-1" href="/tickets/add-full-ticket/<%= event._id %>?seatNumber=<%= seat.seatNumber %>">تذكرة كاملة</a>
                                        </li>
                                        <li>
                                            <a tabindex="-1" href="/tickets/add-half-ticket/<%= event._id %>?seatNumber=<%= seat.seatNumber %>">نصف تذكرة</a>
                                        </li>
                                    </ul>
                                </li>

                                <!-- Owner Ticket option -->
                                <li>
                                    <a style="color: gray !important; cursor: not-allowed;" href="">حجز مالك</a>
                                </li>

                                <!-- Cancel Ticket option -->
                                <li class="dropdown-submenu">
                                    <a style="color: gray !important; cursor: not-allowed;" tabindex="-1" href="#">الغاء تذكرة</a>
                                    <ul class="dropdown-menu" style="text-align: center;">
                                        <p>هل انت متأكد من الغاء التذكرة</p>
                                        <li>
                                            <% if (ticket) { %>
                                                <a style="background-color: green; color: white !important; width: 50%; border-radius: 5px; padding: 10px 0;" href="/tickets/cancel/<%= ticket._id %>">نعم</a>
                                            <% } else { %>
                                                <a style="background-color: grey; color: white !important; width: 50%; border-radius: 5px; padding: 10px 0;">No ticket to cancel</a>
                                            <% } %>
                                        </li>
                                        <li>
                                            <a style="background-color: red; color: white !important; width: 50%; border-radius: 5px; padding: 10px 0;" href="#">لا</a>
                                        </li>
                                    </ul>
                                </li>

                                <% } %>
                        </ul>
                    </div>
                <% }) %>
            </div>
        </div>

        <!-- Event Details Section -->
        <div class="details">
            <h3><%= event.name %></h3>
            <h3><%= event.date %></h3>
            <h3><%= event.formattedTime %></h3>
            <h3><%= event.driverName %></h3>
            <h3><%= event.driverPhoneNumber %></h3>
            <h3><%= event.busPlateNumber %></h3>
            <h3><%= event.busPhoneNumber %></h3>
            <h3><%= event.type %></h3>
            <h3><%= event.numberOfSeats %></h3>
        </div>
    </div>

    <!-- Tickets Section -->
    <div class="tickets">
        <h3>التذاكر</h3>
        <% tickets.forEach(ticket => { %>
            <div class="tickets-container">
                <h4><%= ticket.clientName %></h4>
                <h4><%= ticket.clientPhoneNumber %></h4>
                <p><%= ticket.seatNumber %></p>
                <p><%= ticket.serial %></p>
            </div>
        <% }) %>
    </div>

    <!-- Scripts -->
    <script>
        $(document).ready(function() {
            // Handle submenu toggle
            $('.dropdown-submenu a.test').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).parent().children('ul').toggle();
            });

            // Handle reservation toggle
            $('.toggle-reservation').on('click', function(e) {
                e.preventDefault();
                const seatId = $(this).data('seat-id');
                const seatElement = $(this);

                $.post('/events/toggle-reserve/' + seatId, function(response) {
                    if (response.success) {
                        seatElement.text(response.isReserved ? 'الغاء الحجز المؤقت' : 'حجز مؤقت');
                        seatElement.toggleClass('reserved', response.isReserved);
                    } else {
                        alert('Failed to toggle reservation. Please try again.');
                    }
                }).fail(function() {
                    alert('Error toggling reservation.');
                });
                location.reload();
            });
        });
    </script>
</body>
